## 方案目标
- 解决编辑/新增/删除/状态变更后，切换分页参数导致页面回退到乐观更新前旧数据的问题。
- 提供“家族一致性”默认能力（可配置开关），同时保留业务的精准控制入口。
- 保证对现有使用者零破坏：默认关闭，按需启用；在启用时具备完善的风控与回滚策略。

## 设计原则
- 安全优先：所有新行为均为可选、具保护性，出现不确定时选择“只失效不强同步”。
- 向下兼容：不改变现有 `useMutation`、key 工厂、选择器的默认行为。
- 最小侵入：新增配置与工具而非重写核心逻辑；保持 API 结构一致。
- 可验证：提供完备的单元与集成测试，覆盖编辑/新增/删除/状态变更四类操作及多种分页形态。

## 改动范围
- Hooks：增强 `useMutation` 成功路径，新增“家族一致性”可选配置。
- 工具：新增家族匹配与列表形状适配工具；扩充批量 `setQueryData/invalidate`。
- 类型：新增一致性配置类型，兼容现有 `optimistic` 配置。
- 文档：README 增补“分页家族一致性最佳实践”。

## 技术实现
- 家族匹配
  - 基于资源基 key（例如 `['tanstack-query','users']`）构造 predicate，匹配所有分页/筛选/排序/搜索变体（参考 `createPaginatedKey/createFilteredKey/createSortedKey/createComplexKey`）。
  - 使用 `queryClient.getQueryCache().findAll({ predicate })` 获取命中查询并批量处理。
- 同步策略（成功后）
  - 编辑/删除：对已缓存的家族变体执行按 id 合并或移除；随后批量 `invalidate` 家族变体。
  - 新增/状态变更：默认不跨页强注入，先只对当前页执行（已有行为）；成功后家族级 `invalidate`。若业务提供 `filterMatcher/sortComparator`，在缓存中安全同步插入/迁移，再失效。
- 配置接口（新增，可选）
  - `consistency`: `{ baseKey, mode, listSelector, idField, filterMatcher?, sortComparator?, maxKeys? }`
    - `mode`: `'invalidate' | 'sync+invalidate'`（默认 `'invalidate'`）。
    - `listSelector`: 适配数组或 `{items,total}`；在不确定时返回 `null`，仅失效。
    - `filterMatcher(item, params)`: 判断新增/状态变更是否属于某变体；缺省则不跨页注入。
    - `sortComparator(a,b, params)`: 跨页同步时排序；缺省则保持原序或头/尾插入。
    - `maxKeys`: 防御性限制一次处理的 key 数量，避免大规模缓存导致卡顿。
  - Provider 级开关：`enableFamilyConsistency`（默认 `false`），全局启用后可在每次 mutation 上覆盖。
- 形状适配
  - 数组：直接 `setQueryData(listUpdater.add/update/remove)`。
  - 分页对象：通过 `listSelector` 提取 `items`，应用更新后回写；`total` 在新增/删除时可选择性增减或交由服务端校正。
  - 无限查询：识别 `pages[]` 结构，仅同步当前缓存页中的匹配项；随后失效获取服务端最新。
- 性能与稳定
  - 批量操作使用微任务聚合：收集待处理 keys，一次性批量 `setQueryData` 与 `invalidate`。
  - Try-catch 包裹所有同步操作；出现异常立即降级为仅失效。
  - 谨慎避免对 `staleTime/gcTime` 等用户配置产生副作用。

## 兼容与风控
- 默认关闭：不影响任何现有项目行为。
- 启用后保障
  - 无 `listSelector` 或返回 `null`：仅家族失效（安全）。
  - 无 `idField` 或取不到 id：跳过同步，降级失效。
  - 无 `filterMatcher/sortComparator`：不做跨页注入/迁移，仅在已缓存页内合并更新；再失效。
  - `maxKeys` 超限：截断处理并上报告警（可选择调试日志）。
- 细粒度控制：支持在单次 mutation 上临时关闭或切换 `mode`。

## 测试验证
- 单元测试
  - 数组与分页对象：编辑/新增/删除/状态变更的同步与失效。
  - 家族匹配：分页/筛选/排序/复合 key 的命中准确性。
  - 降级路径：缺失配置与异常场景时仅失效。
- 集成测试
  - 真实 `QueryClient` + 模拟接口（含延迟与错误）；验证：成功后切换 `pageSize`/`page` 不再出现旧快照回退。
  - 无限查询：多页场景的同步与最终一致性。
- 性能回归
  - 大量缓存 key 下的批量操作耗时与 UI 响应。

## 文档与示例
- README 新增章节：
  - “为什么需要家族一致性”与常见陷阱。
  - `consistency` 配置详解与安全默认值。
  - 示例：编辑/新增/删除/状态变更四类场景，含数组/分页对象/无限查询。
  - 迁移指南：保持现有项目零改动的方式与逐步启用策略。

## 发布与回滚
- 版本：`0.2.x` 小版本发布；新增能力为可选，不含破坏性变更。
- 发布流程：
  - 本地与 CI 全量测试通过 → 预览版（canary）供试用 → 稳定版发布。
- 回滚策略：
  - Provider 级开关或 mutation 局部关闭；如需彻底移除，回退到上一小版本。

## 验收标准
- 在启用一致性后，四类操作完成后立刻切换分页参数，页面不出现旧快照回退，最终与服务端一致。
- 在关闭一致性时，现有行为维持不变，无任何回归。
- 性能与稳定满足生产要求；出现异常时自动降级为仅失效模式。